# PDFを章ごとに分割して画像化するアプリ 作成ガイド

## ① 参考ドキュメントに基づく方法のまとめ

### 概要

提示されたドキュメント（Gemini とのやり取り）では、次のような**PDF Structure Master** 型アプリが提案されています。

- **目的**: PDF を「章」単位で分割し、さらに**分割した範囲を画像（JPEG）に変換**して、本タイトル・章名に基づくフォルダに整理する。
- **目次あり**: PDF に埋め込み目次（アウトライン）があればそれを最優先で利用。
- **目次なし**: フォントサイズ分布から「本文」と「見出し」を推定し、章の区切りを自動検出。
- **Human-in-the-Loop**: 自動検出結果を一覧表示し、ユーザーがチェック・編集してから実行。

### 技術スタック（ドキュメント案）

| 項目 | 選択 |
|------|------|
| 言語 | Python |
| PDF 処理 | PyMuPDF (fitz) |
| GUI | Streamlit（Web アプリ） |
| OCR（スキャンPDF用） | ocrmypdf + Tesseract |
| 出力 | 分割 PDF または 章フォルダ内の連番 JPEG（ZIP） |

### 処理フロー（ドキュメント案）

1. PDF アップロード
2. **目次取得** `doc.get_toc()` → あればページ番号付きで章リスト取得
3. **目次が空なら** フォントサイズ解析（`get_text("dict")` の blocks/lines/spans）で「本文より大きい文字」を見出し候補として検出
4. （オプション）スキャンPDFなら **OCR 実行**（ocrmypdf）→ テキスト化後に再解析
5. **UI で分割ポイントを確認・編集**（チェック、階層 Level、タイトル）
6. **出力**  
   - **PDF モード**: 章ごとに PDF を切り出し、階層フォルダで ZIP 化  
   - **画像モード**: 章ごとのページ範囲を **分割してから** 各ページを画像化し、`[本タイトル]/[章]/[節]/001.jpg` のようにフォルダに格納して ZIP 化

### フォルダ構成（画像モード時）

```
[本のタイトル]/
  ├── 第1章 はじめに/
  │     ├── 001.jpg, 002.jpg, ...
  └── 第2章 実践編/
        ├── 第1節 準備/   ← Level 2
        │     ├── 001.jpg, ...
        └── 第2節 実行/
              ├── 001.jpg, ...
```

### コスト・動作環境（ドキュメント上の整理）

- **利用料金**: ローカル実行なら無料（Tesseract / ocrmypdf / PyMuPDF 等はオープンソース）。  
  **注意**: PyMuPDF は AGPL のため、ソース非公開の製品として配布する場合は商用ライセンスが必要。
- **ノートPC**: 分割・画像化は軽い。OCR は CPU 負荷が高く、ページ数に応じて数分かかることがある。
- **PDF の質**: デジタル作成 or OCR 済み PDF が扱いやすく、画像のみのスキャン PDF は OCR が必要。

---

## ② インターネット調査に基づく検証と最良の方法

### 調査で確認したこと

- **目次抽出**: PyMuPDF の `get_toc()` は**埋め込みアウトラインがある PDF にのみ有効**。多くの PDF は「目次ページに書いてあるだけ」でメタデータではないため、**フォントサイズ等のテキスト解析が必須**という見解が複数ある。
- **フォントサイズによる見出し検出**: 「本文（最頻出フォントサイズ）より有意に大きい文字を見出しとする」アプローチは、実装例・ブログで推奨されている。
- **PDF→画像**: PyMuPDF の `get_pixmap(matrix=Matrix(zoom, zoom))` による高解像度化は、Artifex 公式ブログ等で推奨されている。**zoom=2.0 で 144dpi 相当**がよく使われる。
- **GUI**: 「操作しやすい GUI」という要望に対しては、**Streamlit**（すぐ作れる・ブラウザで操作）と **CustomTkinter/PyQt**（デスクトップ単体 exe 化しやすい）のトレードオフがある。

### 最適化の結論（推奨方針）

| 観点 | 推奨 |
|------|------|
| **PDF 解析・分割・画像化** | **PyMuPDF (fitz) を継続利用**。速度・機能・高画質レンダリングのバランスが良い。pypdf は純 Python で AGPL を避けられるが、画像レンダリング・フォント情報の取得では PyMuPDF に劣る。 |
| **目次がない場合の検出** | **既存案の「フォントサイズ分布＋本文より大きい文字を見出し候補」を維持**。必要なら「第1章」「Chapter 1」等の正規表現を**補助**として組み合わせると精度が上がる。 |
| **OCR** | **ocrmypdf + Tesseract** の組み合わせで十分。日本語は `jpn` または `jpn+eng`。 |
| **GUI** | **「操作しやすい」を最優先するなら現状どおり Streamlit でよい**。ブラウザだけで完結し、テーブル編集・ボタン・ダウンロードが簡単。デスクトップ単体 exe にしたい場合は CustomTkinter + PyInstaller（--onedir）の選択肢がある。 |
| **処理順序** | **「章で分割 → その範囲を画像化」** の流れはそのままでよい。メモリ的にも「章範囲だけループしてページ単位で pixmap → 保存」が適切。 |
| **ライセンス** | 個人・社内利用なら PyMuPDF の AGPL は問題にならない。製品販売でソースを出したくない場合は pypdf + pdf2image（poppler）など別スタックの検討が必要。 |

### 追加で検討すると良い点（より「最高の質」に近づけるため）

1. **見出し検出の補強**  
   - 正規表現で「第\d+章」「Chapter\s*\d+」「^\d+\.\s」などを span テキストに適用し、フォントサイズ候補と一致したものを優先する。
2. **画像形式**  
   - 文字・図が主なら **PNG** も選択肢にすると、JPEG の劣化を避けられる。容量を抑えたい場合は JPEG のまま（ドキュメント案の通りで可）。
3. **解像度**  
   - デフォルト **zoom=2.0**（高画質）で問題なし。Retina/高 DPI でも読みやすい。さらに上げるとファイルサイズが増えるのでスライダーで選べる現状で十分。
4. **エラー処理**  
   - 不正 PDF・パスに使えない文字・空の章範囲などで落ちないよう、try/except とサニタイズ（ファイル名の禁止文字除去）を維持する。
5. **OCR の位置づけ**  
   - 「スキャン PDF は OCR してから解析」はそのままでよい。数式・コードのテキスト認識精度は Tesseract では限定的だが、**章タイトル程度の認識**と**分割・画像化の見た目**には十分、という整理でよい。

---

## ③ 確立する「最良の方法」の整理

### アーキテクチャ（確定方針）

1. **エンジン**  
   - PDF: **PyMuPDF (fitz)**（目次取得・テキスト/フォント解析・分割・ページ→画像の一貫利用）。  
   - OCR: **ocrmypdf**（Tesseract 必須。日本語は `jpn+eng` 推奨）。

2. **章の特定**  
   - 第一: `doc.get_toc()` で埋め込み目次を取得。  
   - 第二: 目次が無い/不十分な場合は、`get_text("dict")` でフォントサイズ分布を求め、本文より大きい（例: 1.2 倍以上）テキストを見出し候補として列挙。必要に応じて正規表現で「第○章」等を補助。

3. **人間による確認**  
   - 検出結果を一覧表示し、**出力する/しない・階層 Level・タイトル（フォルダ名）** を編集可能にする。Streamlit の `st.data_editor` のような形式で実装。

4. **出力**  
   - **分割 PDF**: 章範囲で `insert_pdf` して PDF を切り出し、階層フォルダ名で ZIP に格納。  
   - **画像**: 同じ章範囲について、**分割された範囲のページだけ**をループし、各ページを `get_pixmap(matrix=Matrix(zoom,zoom))` で画像化し、`[本タイトル]/[章]/[節]/001.jpg` のように保存して ZIP 化。  
   - 「分割された PDF を画像にする」は、**論理的に「章で分割した範囲」をそのまま画像化する**ことで実現している。

5. **GUI**  
   - **操作しやすさ優先**: **Streamlit** で Web アプリとして実装。  
   - オフライン・単体 exe が必要なら: **CustomTkinter** で同じロジックを包み、PyInstaller で `--onedir` 配布を検討。

### 推奨ファイル・実行手順（Streamlit の場合）

- **メインスクリプト**: ドキュメント最終版の `pdf_master.py`（または `pdf_structure_master.py`）をベースにする。
- **依存関係**  
  - `pip install streamlit pymupdf pandas ocrmypdf`  
  - システムに Tesseract と Ghostscript をインストールし、パスを通す。
- **起動**  
  - `streamlit run pdf_master.py`  
  - サイドバーで「画像(JPEG)フォルダ化」を選び、画質を指定して実行 → ZIP をダウンロード。

### まとめ

- 参考ドキュメントの**「目次優先 → なければフォント解析 → ユーザー確認 → 章で分割 → その範囲を画像化してフォルダ整理」**という流れは、ネット上の実装例・ベストプラクティスと整合している。
- **PyMuPDF + Streamlit + ocrmypdf** の組み合わせは、**精度**と**操作のしやすさ**の両立という意味で、現時点で「最良の方法」として確立してよい。
- 追加するなら「見出しの正規表現補助」「PNG オプション」「ファイル名・例外のサニタイズ」で、さらに堅牢になる。

---

## 付録: 必要なソースコードの所在と役割

本リポジトリでは、実行用のアプリを **`LearningTools/pdf-chapter-splitter/`** に配置しています。

| ファイル | 内容 |
|----------|------|
| `LearningTools/pdf-chapter-splitter/pdf_master.py` | Streamlit UI ＋ PDFProcessor クラス（目次取得・フォント解析・OCR・process_export で PDF/画像の両方）。 |
| `LearningTools/pdf-chapter-splitter/requirements.txt` | 依存パッケージ（streamlit, pymupdf, pandas, ocrmypdf）。 |
| `LearningTools/pdf-chapter-splitter/README.md` | セットアップ・起動方法（`streamlit run pdf_master.py`）。 |

この 1 ファイルに以下が含まれます。

- **PDFProcessor**  
  - `get_existing_toc()`  
  - `detect_chapters_by_style()`  
  - `run_ocr()`  
  - `process_export(chapters, export_mode, img_zoom)`（分割 PDF と章フォルダ画像の両対応）
- **Streamlit**  
  - アップロード、OCR ボタン、出力モード（PDF/画像）、画質、データエディタ、実行・ZIP ダウンロード

**画像化の要所**（「分割された PDF を画像にする」部分）は、`process_export` 内の `export_mode == "image"` のブロックです。  
章ごとの `start_page`〜`end_page` でループし、`page.get_pixmap(matrix=mat)` → `tobytes("jpg")` で ZIP 内に `current_folder/001.jpg` のように書き出しています。

以上が、参考ドキュメントを基にし、インターネットの情報で検証した「PDF を章ごとに分割して画像化するアプリ」の作成方法と、最良の方法の確立内容です。
