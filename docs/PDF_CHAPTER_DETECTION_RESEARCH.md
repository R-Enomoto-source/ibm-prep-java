# 章タイトル検出・ページ区切り問題の調査と改善案

インターネット調査に基づき、章タイトル検出およびページ区切りがうまくいかない問題に対する解決方法を整理しました。

---

## 1. 問題の整理

### よくある失敗パターン

| 現象 | 原因 |
|------|------|
| フッターの「第○章」を誤検出 | ページ下部のノンブル・章ナビがパターンにマッチしてしまう |
| サイドバーの「第○章」を誤検出 | ページ右端の「いま何章か」を示すインジケータがマッチしてしまう |
| 章が見つからない（OCR後） | OCR後のPDFはフォントサイズが均一になり、フォントベースの検出が効かない |
| 目次ページを参照したい | 多くの本に目次があり、正確なページ番号が得られるが、フォーマットが出版社ごとに異なる |

---

## 2. 調査で見つかった手法（評価付き）

### 2.1 PDF埋め込み目次（`get_toc()`）

**概要**: PDFに組み込まれたアウトライン（ブックマーク）を取得する。

| 項目 | 内容 |
|------|------|
| メリット | 最も正確。ページ番号・階層情報がそのまま得られる |
| デメリット | 対応しているPDFは少ない。スキャンPDFにはほぼ存在しない |
| 推奨 | **最優先で試す**。既に実装済み |

---

### 2.2 目次ページのテキスト解析

**概要**: 「目次」「Contents」を含むページを検索し、行末のページ番号をパースする。

| 項目 | 内容 |
|------|------|
| メリット | 多くの書籍で使える。出版社の公式情報に基づく |
| デメリット | フォーマットが多様（「第1章 … 15」「1. Introduction 15」など）。OCR誤認識の影響を受けやすい |
| 研究知見 | HiPS論文（2025）: 目次メタデータの品質が高いと、TOCベース手法が特に有効 |
| 推奨 | **2番目に試す**。既に実装済み。フォーマットの拡張で対応範囲を広げられる |

---

### 2.3 フォントサイズによる見出し検出

**概要**: 本文フォント（最頻出サイズ）より大きい文字を見出し候補とする。

| 項目 | 内容 |
|------|------|
| メリット | ルールが単純で高速。学術論文では約78%の精度（SciPlore Xtract研究） |
| デメリット | OCR後のPDFではフォントが均一になりがちで効果が薄い |
| 研究知見 | **ページ単位**で分布を取る方が、ドキュメント全体の閾値よりロバスト（文献: PDF to Text, Marginalia） |
| 推奨 | **デジタルPDFで有効**。閾値は「中央値の約20%上」が目安 |

---

### 2.4 パターンマッチング（第1章、Chapter 1 など）

**概要**: 正規表現で章タイトルらしい文字列を検出する。

| 項目 | 内容 |
|------|------|
| メリット | OCR後でも使える。多言語対応しやすい |
| デメリット | フッター・サイドバー・本文中の言及もマッチしてしまう |
| 対策 | **位置フィルタ**（ページ上部・中央のみ）＋**フォントサイズ**（本文以上）でノイズを削減 |
| 推奨 | **補助手段**として使用。位置・サイズの組み合わせが重要 |

---

### 2.5 XML変換 + 構造解析（pdftohtml / Poppler）

**概要**: PDFをXMLに変換し、フォントサイズ・位置情報を利用して見出しと境界を推定する。

| 項目 | 内容 |
|------|------|
| メリット | 構造情報が取りやすく、マッチング戦略を組み合わせやすい |
| デメリット | 別ツール（Poppler）の導入が必要。日本語PDFの扱いが難しい場合がある |
| 研究知見 | HiPS論文では、pdftohtmlでXML化し、目次と本文の見出しを複数マッチング戦略で照合 |
| 推奨 | **将来の拡張候補**。現状のPyMuPDF の `get_text("dict")` でほぼ同等の情報は得られる |

---

### 2.6 機械学習・深層学習

**概要**: 見出し/非見出しを分類するモデルを学習させる。

| 項目 | 内容 |
|------|------|
| メリット | 多様なフォーマットに対応できる可能性 |
| デメリット | 教師データが必要。書籍種別ごとに再学習の可能性。実装コストが高い |
| 推奨 | **現時点では過剰**。ルールベースで改善余地が大きい |

---

### 2.7 LLM（大規模言語モデル）による境界推定

**概要**: テキストをLLMに渡し、「章の区切りはどこか」を推論させる。

| 項目 | 内容 |
|------|------|
| メリット | 文脈を理解した柔軟な境界検出が可能。LumberChunker、Meta-Chunking等の先行研究あり |
| デメリット | API利用料・遅延。プライバシー。書籍全体を渡すとトークン制限に抵触 |
| 研究知見 | HiPS論文: LLM + 構造的プリプロセスで誤検出が減少 |
| 推奨 | **上級オプション**。ルールベースで限界に達した場合の検討候補 |

---

### 2.8 外部サービス（Document AI、Adobe PDF Extract 等）

**概要**: クラウドAPIでPDFの構造を解析する。

| 項目 | 内容 |
|------|------|
| メリット | 高精度。見出しレベル・境界の情報が得られる |
| デメリット | 課金。データを外部送信。研究論文向けで、教科書レベルの深い階層には不足な場合あり |
| 推奨 | **法人・商用利用**の選択肢。個人利用ではローカル手法を優先 |

---

## 3. 推奨する改善の優先順位

### すぐ実施可能（コスト低）

1. **位置フィルタの強化**（実装済み）
   - ページ上部のみ（`top_ratio`）
   - 左右マージン除外（`margin_ratio`）でサイドバー・フッターを除外

2. **ページ単位のフォント分布**
   - ドキュメント全体ではなく、**各ページごと**に本文サイズを推定
   - そのページ内で「本文より大きい」テキストだけを見出し候補にする

3. **目次解析のフォーマット拡張**
   - 「1. はじめに 15」「第1章 ……… 15」など多様なパターンに対応
   - 行末の数字の他、リーダー線（…）の後の数字も許容

### 中期的に検討

4. **pdftohtml（Poppler）の導入**
   - XML出力と照合ロジックで、目次と本文の見出しマッチングを強化

5. **フォントサイズ + パターンの必須条件**
   - パターンマッチ時も、**本文サイズ以上**を必須にするオプション
   - OCR後は閾値を緩くする（例: 本文の85%以上）

### 将来的な選択肢

6. **LLMによる検証**
   - 検出候補をLLMに渡し、「章タイトルかどうか」を判定させる
   - 検出数が少ない場合のフォールバックとして利用

---

## 4. まとめ

| 課題 | 推奨アプローチ |
|------|----------------|
| フッター・サイドバー誤検出 | 位置フィルタ（上部・中央のみ）※実装済み |
| OCR後の章検出 | パターン検出 + 位置フィルタ。目次ページ解析の併用 |
| 汎用性の向上 | 目次解析のフォーマット拡張、ページ単位フォント推定 |
| 最高精度を目指す場合 | XML変換 + 複数マッチング戦略、またはLLMの併用 |

**結論**: 現状の「埋め込み目次 → 目次ページ → フォントサイズ → パターン＋位置」という多段階フォールバックは、文献とも整合した妥当な設計です。**ページ単位のフォント推定**と**目次フォーマットの拡張**を次に検討すると、さらに安定性が高まります。

---

## 参考文献・リンク

- [PyMuPDF - get_toc()](https://pymupdf.readthedocs.io/en/latest/document.html#Document.get_toc)
- [Stack Overflow: Extract table of contents from PDF](https://stackoverflow.com/questions/78324009/extract-a-table-of-contentschapters-sub-titles-of-pdf-book-in-python)
- [SciPlore Xtract: Font size for title extraction](https://www.academia.edu/458504/SciPlore_Xtract_Extracting_Titles_from_Scientific_PDF_Documents_by_Analyzing_Style_Information_Font_Size_)
- [HiPS: Hierarchical PDF Segmentation of Textbooks (arXiv 2025)](https://arxiv.org/html/2509.00909v1)
- [PDF to Text - Marginalia](https://www.marginalia.nu/log/a_119_pdf/)
- [Marker - PDF to Markdown](https://github.com/datalab-to/marker)
- [Docling - Document understanding](https://github.com/IBM/docling)
- [GROBID - PDF structure extraction](https://github.com/kermitt2/grobid)
